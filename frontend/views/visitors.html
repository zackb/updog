{{template "_header.html" .}}

{{template "sidebar" .}}

<main class="main-content">
    {{template "topbar" .}}

    <div class="dashboard-content">
        <div class="page-header">
            <h1>Visitor Locations</h1>
            <p>Geographic distribution of your visitors around the world.</p>
        </div>

        <div class="map-container" style="margin-top: 2rem;">
            <div id="map"
                style="height: 600px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
            </div>
        </div>

        <div class="stats-grid" style="margin-top: 2rem;">
            <div class="stat-card">
                <div class="stat-icon visitors">
                    <i class="fa-solid fa-globe"></i>
                </div>
                <div class="stat-details">
                    <h3>Countries</h3>
                    <p class="value">0</p>
                    <span class="trend">Unique locations</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon view">
                    <i class="fa-solid fa-map-pin"></i>
                </div>
                <div class="stat-details">
                    <h3>Top Country</h3>
                    <p class="value">-</p>
                    <span class="trend">Most visitors</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon bounce">
                    <i class="fa-solid fa-earth-americas"></i>
                </div>
                <div class="stat-details">
                    <h3>Continents</h3>
                    <p class="value">0</p>
                    <span class="trend">Global reach</span>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    function initializeMap() {
        if (typeof L === 'undefined') {
            setTimeout(initializeMap, 100);
            return;
        }

        const map = L.map('map').setView([20, 0], 2);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            maxZoom: 19,
        }).addTo(map);

        loadVisitors().then(visitors => {
            visitors.forEach(visitor => {
                // Calculate radius based on pageviews (using sqrt for area proportionality)
                // Minimum radius of 5, scaling factor of 2
                const radius = Math.max(5, Math.sqrt(visitor.pageviews) * 2);

                const marker = L.circleMarker([visitor.lat, visitor.lon], {
                    radius: radius,
                    fillColor: "#238636",
                    color: "#ffffff",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.6
                }).addTo(map);

                const text = `<b>${visitor.location}</b>
                    <br>${visitor.pageviews} visitors
                    <br>${visitor.unique_visitors} unique visitors`;
                marker.bindTooltip(text, {
                    permanent: false,
                    direction: 'top'
                });
            });
        }).catch(error => {
            console.error('Error loading visitor data:', error);
        });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeMap);
    } else {
        initializeMap();
    }
</script>

{{template "_footer.html" .}}
