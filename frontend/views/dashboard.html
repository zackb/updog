{{template "_header.html" .}}

{{template "sidebar" .}}

<!-- Main Content -->
<main class="main-content">
    {{template "topbar" .}}

    <div class="dashboard-content">
        <div class="welcome-section">
            <h1>Dashboard Overview</h1>
            <p>Here's what's happening with your projects today.</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon view">
                    <i class="fa-solid fa-eye"></i>
                </div>
                <div class="stat-details">
                    <h3>Total Views</h3>
                    <p class="value">{{if .Stats.Aggregated}}{{.Stats.Aggregated.TotalPageviews}}{{else}}0{{end}}</p>
                    <span class="trend positive">
                        <i class="fa-solid fa-arrow-up"></i> 12.5%
                    </span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon visitors">
                    <i class="fa-solid fa-user-group"></i>
                </div>
                <div class="stat-details">
                    <h3>Unique Visitors</h3>
                    <p class="value">{{if .Stats.Aggregated}}{{.Stats.Aggregated.UniqueVisitors}}{{else}}0{{end}}</p>
                    <span class="trend positive">
                        <i class="fa-solid fa-arrow-up"></i> 8.2%
                    </span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon bounce">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i>
                </div>
                <div class="stat-details">
                    <h3>Bounce Rate</h3>
                    <p class="value">{{if .Stats.Aggregated}}{{printf "%.1f%%" (mul .Stats.Aggregated.BounceRate
                        100)}}{{else}}0{{end}}</p>
                    <span class="trend negative">
                        <i class="fa-solid fa-arrow-down"></i> 2.1%
                    </span>
                </div>
            </div>
            <!--
            <div class="stat-card">
                <div class="stat-icon time">
                    <i class="fa-solid fa-clock"></i>
                </div>
                <div class="stat-details">
                    <h3>Avg. Time</h3>
                    <p class="value">4m 32s</p>
                    <span class="trend positive">
                        <i class="fa-solid fa-arrow-up"></i> 1.4%
                    </span>
                </div>
            </div>
            -->
        </div>

        <!-- Traffic Overview Section -->
        <div class="charts-section full-width">
            <div class="chart-container main-chart">
                <div class="chart-header">
                    <h2>Traffic Overview</h2>
                    <div class="chart-actions">
                        <a href="?resolution=hourly" class='{{if or (eq .Stats.GraphResolution "hourly") (eq .Stats.GraphResolution "" )}}active{{end}}'>Hourly</a>
                        <a href="?resolution=daily" class='{{if eq .Stats.GraphResolution "daily"}}active{{end}}'>Daily</a>
                        <a href="?resolution=monthly" class='{{if eq .Stats.GraphResolution "monthly"}}active{{end}}'>Monthly</a>
                    </div>
                </div>
                <div class="chart-placeholder">
                    {{if .Stats.GraphData}}
                    {{RenderSVG .Stats.GraphData}}
                    {{else}}
                    <p style="width: 100%; text-align: center; color: var(--text-secondary);">No data available</p>
                    {{end}}
                </div>
            </div>
        </div>

        <!-- Top Pages and Device Usage Section -->
        <div class="charts-section">
            <!-- Recent Activity Table -->
            <div class="table-section">
                <div class="section-header">
                    <h2>Top Pages</h2>
                    <a href="/pages" class="view-all">View All</a>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Page</th>
                                <th>Views</th>
                                <th>Unique</th>
                                <th>Bounce Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .Stats.TopPages}}
                            <tr>
                                <td>
                                    <div class="page-info">
                                        <span class="path">{{.Path}}</span>
                                    </div>
                                </td>
                                <td>{{.Count}}</td>
                                <td>{{.UniqueCount}}</td>
                                <td>{{printf "%.1f" .BounceRate}}%</td>
                            </tr>
                            {{else}}
                            <tr>
                                <td colspan="4" style="text-align: center; color: var(--text-secondary);">No pages
                                    viewed
                                    yet</td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="chart-container secondary-chart">
                <div class="chart-header">
                    <h2>Device Usage</h2>
                </div>
                <div class="donut-chart-placeholder">
                    {{if .Stats.DeviceUsage}}
                    <canvas id="deviceChart" width="200" height="200"></canvas>

                    <script>
                        (function () {
                            const canvas = document.getElementById('deviceChart');
                            const ctx = canvas.getContext('2d');

                            const centerX = 100;
                            const centerY = 100;
                            const outerRadius = 80;
                            const innerRadius = 50;

                            // Prepare segment data
                            const data = [
                                {{ range $index, $d:= .Stats.DeviceUsage }}
                                {{ if $index }}, {{ end }}
                        {
                            label: '{{$d.DeviceType}}',
                                percentage: {{ $d.Percentage }},
                            color: (
                                getComputedStyle(document.documentElement)
                                    .getPropertyValue('--color-{{$d.DeviceType | lower}}')
                                    .trim()
                            ) || (function () {
                                const fallback = {
                                    mobile: '#58a6ff',
                                    desktop: '#238636',
                                    tablet: '#f1e05a'
                                };
                                return fallback['{{$d.DeviceType | lower}}'] || '#58a6ff';
                            })()
                        }
                        {{ end }}
                        ];

                        let currentAngle = -Math.PI / 2; // Start at top

                        // Draw donut slices
                        data.forEach(segment => {
                            const sliceAngle = (segment.percentage / 100) * 2 * Math.PI;

                            ctx.beginPath();
                            ctx.arc(centerX, centerY, outerRadius, currentAngle, currentAngle + sliceAngle);
                            ctx.arc(centerX, centerY, innerRadius, currentAngle + sliceAngle, currentAngle, true);
                            ctx.closePath();

                            ctx.fillStyle = segment.color;
                            ctx.fill();

                            currentAngle += sliceAngle;
                        });
                    }) ();
                    </script>

                    <div class="donut-center">
                        <span>Total Devices</span>
                        <strong>{{len .Stats.DeviceUsage}}</strong>
                    </div>
                    {{else}}
                    <div class="donut-center">
                        <span>No Data</span>
                        <strong>-</strong>
                    </div>
                    {{end}}

                </div>
                <div class="chart-legend">
                    {{range .Stats.DeviceUsage}}
                    <div class="legend-item">
                        <span class="dot {{.DeviceType | lower}}"></span> {{.DeviceType}}
                        ({{printf "%.1f" .Percentage}}%)
                    </div>
                    {{end}}
                </div>
            </div>
        </div>
    </div>
</main>


{{template "_footer.html" .}}
